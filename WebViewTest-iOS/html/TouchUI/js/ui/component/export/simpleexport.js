/*!
 * simple export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,t,i){"use strict";if(e&&"undefined"==typeof e.Export){var n=(Array.prototype.splice,3e3),r=function(t,n){var r=this;r.el=t&&1==t.nodeType?t:i.getElementById(t),r.el&&r.el.nodeType&&(r.id=e.attr(r.el,"id"))&&(n&&e.isObject(n)&&e.extend(r,n),e.attr(r.el,"x-wade-uicomponent")||e.attr(r.el,"x-wade-uicomponent","simpleexport"),r._init(),r.constructor.call(r))};r.prototype=e.extend(new e.UIComponent,{setParams:function(t){var i=this;t&&e.isString(t)&&(i.params=t)},buildParams:function(t){var i=this,n=[];return n.push("rpcSessionId="+i.rpcSessionId),n.push("pushMode="+i.pushMode),n.push("config="+(i.configFile?i.configFile:"")),n.push("ftpSite="+(i.ftpCode?i.ftpCode:"")),n.push("filePath="+(i.filePath?i.filePath:"export")),n.push("fileId="+(i.file?i.file.fileId:"")),n.push("fileType="+(i.fileType?i.fileType:"")),n.push("model="+(i.model?i.model:"")),n.push("posX="+(i.posX?i.posX:"")),n.push("posY="+(i.posY?i.posY:"")),n.push("fileSerializeId="+(i.fileSerializeId?i.fileSerializeId:"")),n.push("taskId="+(i.taskId?i.taskId:"")),n.push("serviceName="+(i.taskId?i.taskId:"")),n.push("listenerMethod="+(t?t:"")),n.push("fileName="+encodeURIComponent(i.fullFileName)),e.ajax.buildSubmitData(i.cond,n.join("&")+(i.params&&e.isString(i.params)?"&"+i.params:""))},tip:function(e,t){var i=this;void 0!=e&&(i.el.value=e),void 0!=t&&(i.el.className="e_left "+t)},getDisabled:function(){var e=this;return e.disabled},setDisabled:function(t){var i=this;i.disabled=!!t,i.el.disabled=i.disabled,setTimeout(function(){var t=i.span.className?i.span.className:"";i.disabled?(" "+t+" ").indexOf(" e_dis ")<0&&(i.span.className=e.trim(t+" e_dis")):(t=e.trim((" "+t+" ").replace(/ e_dis /gi," ")),i.span.className=t)},0)},destroy:function(){var e=this;e.rpc&&(e.rpc.destroy(),e.rpc=null),e.span=null,e.btnReset=null,e.btnDownload=null,e.btnExport=null,e.progEl=null,e.progBarEl=null,e.el=null},_init:function(){var i=this;i.span=e(i.el).parent("span.e_mix:first")[0],i.btnReset=e(i.span).find("span.e_ico-reset:first").parent("button")[0],i.btnDownload=e(i.span).children("span.e_ico-download:first")[0],i.btnExport=e(i.span).find("span.e_ico-export:first").parent("button")[0],i.progEl=e(i.span).children("span.e_mixProgress:first")[0],i.progBarEl=e(i.progEl).children("span.e_mixBar:first")[0],i.fileTypes&&(i.fileTypes=e.FileTransfer.fileTypes(i.fileTypes)),i.rpcSessionId=e.expando+"_"+e.rand(1e6)+"_"+i.id,setTimeout(function(){e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleexport.tip.export-file-download"))},0),e(i.btnReset).tap(function(){i.disabaled||!0===i.exporting||(e.attr(i.el,"readOnly",null),i.btnReset.style.display="none",i.btnDownload.style.display="none",i.btnExport.style.display="",i.progBarEl.style.width="0%",i.el.value=i.fileName?i.fileName:"",i.tip(i.defaultTip,"e_black-light"))}),e(i.btnDownload).tap(function(){i.disabaled||!0===i.exporting||i.downUrl&&t.open(i.downUrl+"&_="+Math.random(),"_new_download_win","height=40,width=100,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}),e(i.btnExport).tap(function(){if(!i.disabaled&&!0!==i.exporting){var r=i.fileName=i.el.value;if(r&&e.trim(r)){var l=e("#"+i.id+"_filetype_sel").val();if(i.fileTypes&&e.inArray(l,i.fileTypes)<0)return void i.tip(e.lang.get("ui.component.simpleexport.tip.invalid-filename"),"e_red");i.fullFileName=r+l,!1!==e.event.trigger("beforeAction",null,i.el)&&(i.fileSerializeId=null,e.attr(i.el,"readOnly",!0),i.tip(e.lang.get("ui.component.simpleexport.tip.begin-export",r)),e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(l){if(i.fileSerializeId=l.fileSerializeId,i.messageServer=l.messageServer,i.messageServerType=l.messageServerType?l.messageServerType:null,!0===i.exporting)if("10"==l.progress)i.tip(e.lang.get("ui.component.simpleexport.tip.export-started"));else{if(!i.fileSerializeId&&"error"==l.status)return i.exporting=!1,i.progBarEl.style.width="0%",void i.tip(l.hint,"e_red");i.progBarEl.style.width=l.progress+"%",i.tip(e.lang.get("ui.component.simpleexport.tip.exporting",l.progress,r))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new e.RPC({address:i.messageServer,type:i.messageServerType,session:"&sessionId="+i.rpcSessionId,message:function(t){if(t&&e.isObject(t))if("prog"!=t.STATUS){if(i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none","ok"==t.STATUS){i.progBarEl.style.width="100%";var n=i.downUrl=t.DOWNLOAD_URL;n&&(i.btnDownload.style.display=""),i.tip(e.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light")}else"error"==t.STATUS&&(i.progBarEl.style.width="0%",i.tip(t.ERROR_INFO,"e_red"));e.event.trigger("afterAction",t.STATUS,i.el)}else if(t.PROG){var r=(""+t.PROG).indexOf("%")>-1?t.PROG:t.PROG+"%";i.progBarEl.style.width=r,i.tip(e.lang.get("ui.component.simpleexport.tip.exporting",r,i.fileName))}}}),i.rpc.open()):i.timer=t.setInterval(function(){return i.fileSerializeId?void e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(n){if(!n||!e.isObject(n))return void t.clearInterval(i.timer);if("100"==n.progress||"error"==n.status){if(t.clearInterval(i.timer),i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none","ok"==n.status){i.progBarEl.style.width="100%";var r=i.downUrl=n.downloadUrl;r&&(i.btnDownload.style.display=""),i.tip(e.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light")}else"error"==n.status&&(i.progBarEl.style.width="0%",i.tip(n.hint,"e_red"));e.event.trigger("afterAction",n.status,i.el)}},error:function(n,r,l){t.clearInterval(i.timer),i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none",i.tip(e.lang.get("ui.component.simpleexport.tip.export-faild",r),"e_red")}}):void t.clearInterval(i.timer)},n)},error:function(t,n,r){i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none",i.tip(e.lang.get("ui.component.simpleexport.tip.export-faild",n),"e_red")}}),i.exporting=!0)}}})}}),t.SimpleExport=e.SimpleExport=r}}(window.Wade,window,document);